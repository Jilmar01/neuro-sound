<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neuro-Sound Responsive</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="Styles/home.css">
    <script src="https://sdk.scdn.co/spotify-player.js"></script>


    <style>
        /* CSS INCRUSTADO POR SI NO CARGA EL ARCHIVO EXTERNO */
        /* (Solo para asegurar que se vea bien en esta vista previa) */
        body { height: 100vh; background: linear-gradient(135deg, #4c92cd, #7f72a6, #7960a2); background-size: cover; overflow: hidden; }
        .glass-panel { background: rgba(255, 255, 255, 0.12); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.25); border-radius: 15px; color: white; }
        .sidebar-container { background: rgba(255, 255, 255, 0.12); backdrop-filter: blur(10px); border-right: 1px solid rgba(255, 255, 255, 0.2); display: flex; flex-direction: column; align-items: center; padding-top: 20px; height: 100%; }
        .sidebar-item { padding: 15px 0; cursor: pointer; border-radius: 10px; transition: 0.2s; width: 80%; display: flex; flex-direction: column; align-items: center; }
        .sidebar-item:hover { background: rgba(255, 255, 255, 0.25); transform: scale(1.05); }
        .header { background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.25); border-radius: 15px; padding: 15px 25px; margin: 15px; }
        .searchfield input { background: rgba(255, 255, 255, 0.2); border: none; color: white; border-radius: 20px; }
        .mobile-navbar { background: rgba(20, 20, 20, 0.6); backdrop-filter: blur(15px); border-top: 1px solid rgba(255,255,255,0.2); z-index: 1050; }
        .offcanvas-glass { background: linear-gradient(135deg, #5b537a, #3e7cae); color: white; backdrop-filter: blur(10px); }
        .mobile-player { position: fixed; bottom: 75px; left: 10px; right: 10px; height: 65px; z-index: 1040; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; }
    </style>
    
</head>
<body>

    <div class="container-fluid h-100 p-0">
        <div class="row h-100 g-0">
            
            <div class="col-md-1 d-none d-md-block h-100">
                <div class="sidebar-container">
                    <div class="mb-5 mt-3"><i class="bi bi-vinyl fs-1 text-white"></i></div>
                    <ul class="list-unstyled d-flex flex-column gap-3 w-100 align-items-center">
                        
                        <li class="sidebar-item">
                            <i class="bi bi-house-door-fill fs-4 text-white"></i>
                            <span class="small mt-1 text-white">Home</span>
                        </li>
                        
                        <li class="sidebar-item">
                            <i class="bi bi-music-note-list fs-4 text-white"></i>
                            <span class="small mt-1 text-white">Playlists</span>
                        </li>

                        <li class="sidebar-item">
                            <a href="settings.html" style="text-decoration: none; color: white; display: flex; flex-direction: column; align-items: center; width: 100%;">
                                <i class="bi bi-gear-fill fs-4"></i>
                                <span class="small mt-1">Ajustes</span>
                            </a>
                        </li>

                        <li class="sidebar-item mt-auto mb-4">
                            <a href="login.html" style="text-decoration: none; color: white; display: flex; flex-direction: column; align-items: center; width: 100%;">
                                <i class="bi bi-box-arrow-left fs-4"></i>
                                <span class="small mt-1">Logout</span>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

            <div class="col-12 col-md-11 d-flex flex-column h-100">
                
                <div class="flex-shrink-0">
                    <div class="header d-flex align-items-center justify-content-between">
                        <div class="logo d-flex align-items-center">
                            <i class="bi bi-soundwave fs-2 text-white d-md-none me-2"></i> 
                            <h1 class="mb-0 fs-5 fw-bold text-white d-none d-sm-block">Neuro-Sound</h1>
                        </div>
                        <div class="searchfield position-relative flex-grow-1 mx-3" style="max-width: 400px;">
                            <input id="spotifySearchInput"type="text" class="form-control ps-5 py-2" placeholder="Buscar...">
                            <i class="bi bi-search position-absolute top-50 start-0 translate-middle-y ms-3 text-white"></i>
                        </div>
                        
                        <div class="profile text-white">
                            <a href="settings.html" class="text-white">
                                <i class="bi bi-person-circle fs-2"></i>
                            </a>
                        </div>
                    </div>
                </div>

                <div class="row flex-grow-1 m-0 overflow-hidden">
                    
                    <div class="col-12 col-md-9 h-100 p-0">
                        <div class="space h-100 p-3 d-flex flex-column" style="padding-bottom: 100px;"> <div class="content-area glass-panel p-4 h-100 overflow-auto">
                                <h2 class="mb-3">Explorar</h2>
                                
                                <div class="row g-3" id="mainPanel">

                                </div>
                                <div id="spotifySearchResults" class="mt-4">

                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 d-none d-md-flex flex-column gap-3 p-3 pt-0 h-100">
                        <div class="glass-panel flex-grow-1 p-3 overflow-auto">
                            <h5>Estadísticas</h5>
                            <div class="d-flex align-items-center justify-content-center h-50 border border-light rounded opacity-50 mt-3">Gráfico</div>
                        </div>
                        <div class="glass-panel p-3">
                        <!-- Desktop panel -->
                        <div class="d-flex align-items-center gap-3 mb-2">
                            <img id="trackCoverDesktop" src="" style="width:50px; height:50px; border-radius:8px;" />
                            <div>
                                <h6 id="trackNameDesktop" class="m-0">Track Name</h6>
                                <small id="trackArtistDesktop" class="opacity-75">Artist</small>
                            </div>
                        </div>
                        <div class="d-flex justify-content-center gap-3 fs-4 my-2">
                            <i id="btnPrevDesktop" class="bi bi-skip-backward-fill"></i>
                            <i id="btnPlayDesktop" class="bi bi-play-circle-fill"></i>
                            <i id="btnNextDesktop" class="bi bi-skip-forward-fill"></i>
                        </div>
                        <div class="mt-3">
                            <div class="progress" id="progressContainerDesktop" style="height: 6px; background: rgba(255,255,255,0.2); cursor: pointer;">
                                <div class="progress-bar" id="progressBarDesktop" style="width:0%; background: rgba(255,255,255,0.8); transition: width 0.1s linear;"></div>
                            </div>
                            <div class="d-flex justify-content-between mt-2 small opacity-75">
                                <span id="currentTimeDesktop">0:00</span>
                                <span id="totalTimeDesktop">0:00</span>
                            </div>
                        </div>

                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <div class="mobile-player glass-panel d-md-none shadow-lg">
        <div class="d-flex align-items-center gap-2">
            <div style="width:40px; height:40px; background:#333; border-radius:5px;"></div> <div class="lh-1">
                <p class="m-0 fw-bold small">Die For You</p>
                <small class="m-0 text-white-50" style="font-size: 0.7rem;">The Weeknd</small>
            </div>
        </div>
        <div class="d-flex align-items-center gap-3 fs-3">
            <i class="bi bi-play-fill text-white"></i>
            <i class="bi bi-skip-forward-fill text-white"></i>
        </div>
        <div style="position:absolute; bottom:0; left:15px; right:15px; height:2px; background:rgba(255,255,255,0.3);">
            <div style="width:40%; height:100%; background:white;"></div>
        </div>
    </div>

    <nav class="navbar fixed-bottom mobile-navbar d-md-none justify-content-around">
        <div class="text-center text-white">
            <i class="bi bi-house-door-fill fs-4"></i>
            <div style="font-size: 0.7rem;">Home</div>
        </div>
        
        <div class="text-center text-white" data-bs-toggle="offcanvas" data-bs-target="#mobileCharts">
            <i class="bi bi-bar-chart-fill fs-4 text-info"></i>
            <div style="font-size: 0.7rem;">Charts</div>
        </div>

        <div class="text-center text-white">
            <i class="bi bi-music-note-list fs-4"></i>
            <div style="font-size: 0.7rem;">Playlist</div>
        </div>
        
        <a href="settings.html" class="text-center text-white text-decoration-none">
            <i class="bi bi-person fs-4"></i>
            <div style="font-size: 0.7rem;">Perfil</div>
        </a>
    </nav>

    <div class="offcanvas offcanvas-bottom offcanvas-glass h-75" tabindex="-1" id="mobileCharts">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title">Estadísticas y Datos</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body">
            <div class="p-3 bg-white bg-opacity-10 rounded mb-3">
                <h6>Reproducciones Semanales</h6>
                <div style="height: 150px; border-bottom: 2px solid white; display:flex; align-items:end; gap:5px;">
                    <div style="width:20%; height:40%; background:rgba(255,255,255,0.5)"></div>
                    <div style="width:20%; height:70%; background:rgba(255,255,255,0.8)"></div>
                    <div style="width:20%; height:50%; background:rgba(255,255,255,0.5)"></div>
                </div>
            </div>
            <p>Aquí va todo el contenido de los gráficos.</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
window.onSpotifyWebPlaybackSDKReady = () => {
    const token = localStorage.getItem('spotifyToken');
    if (!token) return console.error('No Spotify token found');

    const player = new Spotify.Player({
        name: 'Neuro-Sound Player',
        getOAuthToken: cb => { cb(token); },
    });

    let progressInterval = null;

    function formatTime(ms) {
        const minutes = Math.floor(ms / 60000);
        const seconds = Math.floor((ms % 60000) / 1000);
        return `${minutes}:${seconds.toString().padStart(2,'0')}`;
    }

    function updateProgressUI(state) {
        if (!state) return;
        const track = state.track_window.current_track;
        const progressPercent = (state.position / state.duration) * 100;
        const formattedCurrent = formatTime(state.position);

        // Desktop
        const progressDesktop = document.getElementById('progressBarDesktop');
        const currentDesktop = document.getElementById('currentTimeDesktop');
        if (progressDesktop) progressDesktop.style.width = progressPercent + '%';
        if (currentDesktop) currentDesktop.innerText = formattedCurrent;

        // Mobile
        const progressMobile = document.getElementById('progressBarMobile');
        if (progressMobile) progressMobile.style.width = progressPercent + '%';
    }

    player.addListener('player_state_changed', state => {
        if (!state) return;

        // Actualiza UI principal
        updateProgressUI(state);

        // Actualiza info del track si cambió
        const track = state.track_window.current_track;
        const coverDesktop = document.getElementById('trackCoverDesktop');
        const nameDesktop = document.getElementById('trackNameDesktop');
        const artistDesktop = document.getElementById('trackArtistDesktop');
        const totalDesktop = document.getElementById('totalTimeDesktop');
        const coverMobile = document.getElementById('trackCover');
        const nameMobile = document.getElementById('trackName');
        const artistMobile = document.getElementById('trackArtist');

        if (coverDesktop) coverDesktop.src = track.album.images[0].url;
        if (nameDesktop) nameDesktop.innerText = track.name;
        if (artistDesktop) artistDesktop.innerText = track.artists.map(a=>a.name).join(', ');
        if (totalDesktop) totalDesktop.innerText = formatTime(state.duration);

        if (coverMobile) coverMobile.src = track.album.images[0].url;
        if (nameMobile) nameMobile.innerText = track.name;
        if (artistMobile) artistMobile.innerText = track.artists.map(a=>a.name).join(', ');
    });

    // Controles
    ['btnPlayDesktop','btnNextDesktop','btnPrevDesktop','btnPlay','btnNext','btnPrev'].forEach(id => {
        const btn = document.getElementById(id);
        if (!btn) return;
        if (id.includes('Play')) btn.addEventListener('click', ()=>player.togglePlay());
        if (id.includes('Next')) btn.addEventListener('click', ()=>player.nextTrack());
        if (id.includes('Prev')) btn.addEventListener('click', ()=>player.previousTrack());
    });

    player.connect();

    // Interval para actualizar barra continuamente
    setInterval(async () => {
        const state = await player.getCurrentState();
        if (!state) return;
        updateProgressUI(state);
    }, 500); // Cada 0.5s
};
</script>
<script>
const searchInput = document.getElementById('spotifySearchInput');
const resultsContainer = document.getElementById('spotifySearchResults');
const token = localStorage.getItem('spotifyToken');

if (!token) console.error('No Spotify token found');

// Función para buscar en Spotify
async function searchSpotify(query) {
    if (!query) return;
    const url = `https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=track&limit=8`;
    const response = await fetch(url, {
        headers: { Authorization: `Bearer ${token}` }
    });
    const data = await response.json();
    return data;
}

// Mostrar resultados en el contenido
function displayResults(data) {
    if (!data || !data.tracks) return;
    resultsContainer.innerHTML = ''; // Limpiar resultados anteriores

    data.tracks.items.forEach(track => {
        const trackDiv = document.createElement('div');
        trackDiv.className = 'd-flex align-items-center mb-2 p-2 rounded hover-glass';
        trackDiv.style.cursor = 'pointer';
        trackDiv.innerHTML = `
            <img src="${track.album.images[2]?.url || ''}" width="50" height="50" style="border-radius:5px; margin-right:10px;">
            <div>
                <strong>${track.name}</strong><br>
                <small>${track.artists.map(a=>a.name).join(', ')}</small>
            </div>
        `;
        trackDiv.addEventListener('click', () => {
            // Reproducir canción en tu player
            player.play({ uris: [track.uri] });
        });
        resultsContainer.appendChild(trackDiv);
    });
}

// Escucha input con debounce
let debounceTimer;
searchInput.addEventListener('input', e => {
    clearTimeout(debounceTimer);
    const query = e.target.value.trim();
    if (!query) {
        resultsContainer.innerHTML = '';
        return;
    }
    debounceTimer = setTimeout(async () => {
        const data = await searchSpotify(query);
        displayResults(data);
    }, 400);
});
</script>

<script>
let playerDeviceId = null;

// ============================
// INICIALIZAR WEB PLAYBACK SDK
// ============================
window.onSpotifyWebPlaybackSDKReady = () => {
    const player = new Spotify.Player({
        name: "Neuro-Sound Player",
        getOAuthToken: cb => cb(token)
    });

    player.addListener("ready", ({ device_id }) => {
        console.log("Player listo:", device_id);
        playerDeviceId = device_id;
    });

    player.connect();
};

// ============================
// 1) OBTENER PLAYLISTS PÚBLICAS
// ============================
// ⚠ Cambiado a: /v1/browse/featured-playlists porque las de "spotify" NO son públicas vía API
async function fetchSpotifyPlaylists() {
    try {
        const res = await fetch(
            "https://api.spotify.com/v1/browse/featured-playlists?limit=8",
            { headers: { "Authorization": "Bearer " + token } }
        );

        if (!res.ok) throw new Error("Error: " + res.status);
        const data = await res.json();

        renderPlaylists(data.playlists.items);

    } catch (err) {
        console.error("Error al cargar playlists:", err);
    }
}

// ============================
// 2) MOSTRAR PLAYLISTS EN EL PANEL
// ============================
function renderPlaylists(playlists) {
    const panel = document.getElementById("mainPanel");
    if (!panel) return console.error("mainPanel no encontrado");

    panel.innerHTML = "<h4 class='text-white mb-3'>Playlists destacadas</h4><div class='row'>";

    playlists.forEach(p => {
        const img = p.images[0]?.url || "";
        const id = p.id;

        panel.innerHTML += `
            <div class="col-6 col-md-3 text-center">
                <div class="card bg-dark text-white p-2 playlist-card" data-id="${id}">
                    <img src="${img}" class="img-fluid rounded mb-2">
                    <p class="fw-bold">${p.name}</p>
                </div>
            </div>
        `;
    });

    panel.innerHTML += "</div>";

    document.querySelectorAll(".playlist-card").forEach(card => {
        card.addEventListener("click", () => {
            loadPlaylistTracks(card.dataset.id);
        });
    });
}

// ============================================
// 3) AL CLIC → CARGAR CANCIONES EN EL PANEL
// ============================================
async function loadPlaylistTracks(playlistId) {
    try {
        const res = await fetch(
            `https://api.spotify.com/v1/playlists/${playlistId}/tracks`,
            { headers: { "Authorization": "Bearer " + token } }
        );

        if (!res.ok) throw new Error("No se pudieron cargar canciones");

        const data = await res.json();
        renderTracks(data.items);

    } catch (err) {
        console.error("Error:", err);
    }
}

// ===============================
// 4) MOSTRAR CANCIONES EN EL PANEL
// ===============================
function renderTracks(tracks) {
    const panel = document.getElementById("mainPanel");
    if (!panel) return console.error("mainPanel no encontrado");

    panel.innerHTML = "<h4 class='text-white mb-3'>Canciones</h4><div class='row'>";

    tracks.forEach(item => {
        const t = item.track;
        if (!t) return;

        const img = t.album.images[0]?.url || "";
        const name = t.name;
        const artists = t.artists.map(a => a.name).join(", ");
        const uri = t.uri;

        panel.innerHTML += `
            <div class="col-12 song-row d-flex align-items-center p-2 bg-dark mb-2 rounded"
                 data-uri="${uri}" style="cursor:pointer;">
                <img src="${img}" width="60" class="rounded me-3">
                <div>
                    <p class="m-0 fw-bold">${name}</p>
                    <small class="text-secondary">${artists}</small>
                </div>
            </div>
        `;
    });

    panel.innerHTML += "</div>";

    document.querySelectorAll(".song-row").forEach(row => {
        row.addEventListener("click", () => {
            playSong(row.dataset.uri);
        });
    });
}

// ============================
// 5) REPRODUCIR CANCIÓN
// ============================
function playSong(uri) {
    if (!playerDeviceId) {
        console.error("Device ID no listo todavía.");
        return;
    }

    fetch(`https://api.spotify.com/v1/me/player/play?device_id=${playerDeviceId}`, {
        method: "PUT",
        headers: {
            "Authorization": "Bearer " + token,
            "Content-Type": "application/json"
        },
        body: JSON.stringify({ uris: [uri] })
    })
    .then(res => {
        if (!res.ok) console.error("No se pudo reproducir:", res.status);
    });
}

// ============================
// 6) INICIAR AUTOMÁTICAMENTE
// ============================
document.addEventListener("DOMContentLoaded", fetchSpotifyPlaylists);
</script>

</body>
</html>