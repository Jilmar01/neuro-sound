<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario Musical Personalizado</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="Styles/form.css">
    <style>
        /* Estilos adicionales para los reproductores de audio */
        audio {
            width: 100%;
            margin-bottom: 10px;
        }
        .genre-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
        }
    </style>
</head>

<body>

<div class="container mt-5">

    <div id="section1" class="section active">
        <h2>1. Consentimiento</h2>
        <div class="question">
            <label>¬øAcepta que sus respuestas se utilicen para personalizar su experiencia musical?</label>
            <select id="consent" class="form-select">
                <option value="Si">S√≠</option>
                <option value="No">No</option>
            </select>
        </div>
        <button class="btn btn-primary mt-3" onclick="handleConsent()">Siguiente</button>
    </div>

    <div id="section2" class="section" style="display:none;">
        <button class="btn btn-outline-secondary mb-3" onclick="previousSection(2)"><i class="bi bi-arrow-left"></i> Atr√°s</button>
        <h2>2. Estado Emocional</h2>

        <div class="question mb-3">
            <label>2.1 ¬øCu√°l de estas emociones describe mejor c√≥mo se siente ahora?</label>
            <select id="currentEmotion" class="form-select">
                <option value="Tristeza">Tristeza</option>
                <option value="Calma">Calma</option>
                <option value="Felicidad">Felicidad</option>
                <option value="Ira">Ira</option>
            </select>
        </div>

        <div class="question mb-3">
            <label>2.2 ¬øQu√© tan intensa es esta emoci√≥n? (1 = muy leve, 5 = muy fuerte)</label>
            <input id="emotionIntensity" type="range" class="form-range" min="1" max="5" step="1" oninput="document.getElementById('intensityVal').innerText = this.value">
            <div class="text-center fw-bold" id="intensityVal">3</div>
        </div>

        <button class="btn btn-primary" onclick="nextSection(2)">Siguiente</button>
    </div>

    <div id="section3" class="section" style="display:none;">
        <button class="btn btn-outline-secondary mb-3" onclick="previousSection(3)"><i class="bi bi-arrow-left"></i> Atr√°s</button>
        <h2>3. Test de Tonos Puros</h2>

        <div class="question mb-4">
            <label>3.1 Escuche los siguientes tonos:</label>
            <div class="mb-2">
                <strong>Tono 1:</strong>
                <audio controls>
                    <source src="audios/tono1.mp3" type="audio/mpeg">
                    Tu navegador no soporta audio.
                </audio>
            </div>
            <div class="mb-2">
                <strong>Tono 2:</strong>
                <audio controls>
                    <source src="audios/tono2.mp3" type="audio/mpeg">
                </audio>
            </div>
            <div class="mb-2">
                <strong>Tono 3:</strong>
                <audio controls>
                    <source src="audios/tono3.mp3" type="audio/mpeg">
                </audio>
            </div>
        </div>

        <div class="question mb-3">
            <label>3.2 ¬øQu√© tono le agrad√≥ m√°s?</label>
            <select id="likedTone" class="form-select">
                <option value="Tono 1">Tono 1</option>
                <option value="Tono 2">Tono 2</option>
                <option value="Tono 3">Tono 3</option>
            </select>
        </div>

        <div class="question mb-3">
            <label>3.3 ¬øQu√© tono le desagrad√≥ m√°s?</label>
            <select id="dislikedTone" class="form-select">
                <option value="Tono 1">Tono 1</option>
                <option value="Tono 2">Tono 2</option>
                <option value="Tono 3">Tono 3</option>
            </select>
        </div>

        <button class="btn btn-primary" onclick="nextSection(3)">Siguiente</button>
    </div>

    <div id="section4" class="section" style="display:none;">
        <button class="btn btn-outline-secondary mb-3" onclick="previousSection(4)"><i class="bi bi-arrow-left"></i> Atr√°s</button>
        <h2>4. G√©neros Musicales Preferidos</h2>

        <div class="question mb-3">
            <label>Marque todos los que disfrute:</label>
            <div class="genre-grid mt-2">
                <div class="form-check"><input class="form-check-input genreCheck" type="checkbox" value="Blues"> <label>Blues</label></div>
                <div class="form-check"><input class="form-check-input genreCheck" type="checkbox" value="Indie"> <label>Indie</label></div>
                <div class="form-check"><input class="form-check-input genreCheck" type="checkbox" value="Reggae"> <label>Reggae</label></div>
                <div class="form-check"><input class="form-check-input genreCheck" type="checkbox" value="Soul"> <label>Soul</label></div>
                <div class="form-check"><input class="form-check-input genreCheck" type="checkbox" value="Ambient"> <label>Ambient</label></div>
                <div class="form-check"><input class="form-check-input genreCheck" type="checkbox" value="House"> <label>House</label></div>
                <div class="form-check"><input class="form-check-input genreCheck" type="checkbox" value="Reggaeton"> <label>Reggaeton</label></div>
                <div class="form-check"><input class="form-check-input genreCheck" type="checkbox" value="Rock"> <label>Rock</label></div>
                <div class="form-check"><input class="form-check-input genreCheck" type="checkbox" value="Classical"> <label>Classical</label></div>
                <div class="form-check"><input class="form-check-input genreCheck" type="checkbox" value="Pop"> <label>Pop</label></div>
                <div class="form-check"><input class="form-check-input genreCheck" type="checkbox" value="Folk"> <label>Folk</label></div>
                <div class="form-check"><input class="form-check-input genreCheck" type="checkbox" value="Metal"> <label>Metal</label></div>
                <div class="form-check"><input class="form-check-input genreCheck" type="checkbox" value="EDM"> <label>EDM</label></div>
                <div class="form-check"><input class="form-check-input genreCheck" type="checkbox" value="Hip-Hop"> <label>Hip-Hop</label></div>
                <div class="form-check"><input class="form-check-input genreCheck" type="checkbox" value="K-Pop"> <label>K-Pop</label></div>
                <div class="form-check"><input class="form-check-input genreCheck" type="checkbox" value="Country"> <label>Country</label></div>
                <div class="form-check"><input class="form-check-input genreCheck" type="checkbox" value="RnB"> <label>RnB</label></div>
                <div class="form-check"><input class="form-check-input genreCheck" type="checkbox" value="Jazz"> <label>Jazz</label></div>
                <div class="form-check"><input class="form-check-input genreCheck" type="checkbox" value="Lofi"> <label>Lofi</label></div>
                <div class="form-check"><input class="form-check-input genreCheck" type="checkbox" value="Gospel"> <label>Gospel</label></div>
            </div>
        </div>

        <div class="question mb-3">
            <label>4.1 Artista actual de inter√©s:</label>
            <input type="text" id="currentArtist" class="form-control" placeholder="Escriba el artista...">
        </div>

        <div class="question mb-3">
            <label>4.2 Preferencia de tipo de canci√≥n:</label>
            <select id="tempoPref" class="form-select">
                <option value="Muy lentas y solemnes">Muy lentas y solemnes</option>
                <option value="Lentas y tranquilas">Lentas y tranquilas</option>
                <option value="Ritmo moderado">Ritmo moderado</option>
                <option value="R√°pidas y animadas">R√°pidas y animadas</option>
                <option value="Muy r√°pidas e intensas">Muy r√°pidas e intensas</option>
            </select>
        </div>

        <button class="btn btn-primary" onclick="nextSection(4)">Siguiente</button>
    </div>

    <div id="section5" class="section" style="display:none;">
        <button class="btn btn-outline-secondary mb-3" onclick="previousSection(5)"><i class="bi bi-arrow-left"></i> Atr√°s</button>
        <h2>5. Intenci√≥n Emocional</h2>

        <div class="question mb-3">
            <label>Seleccione lo que desea que la m√∫sica haga por usted:</label>
            <select id="emotionalGoal" class="form-select">
                <option value="Mantener c√≥mo me siento">Mantener c√≥mo me siento</option>
                <option value="Sentirme m√°s feliz">Sentirme m√°s feliz</option>
                <option value="Relajarme">Relajarme</option>
                <option value="Aumentar mi energ√≠a">Aumentar mi energ√≠a</option>
                <option value="Ayudarme a concentrarme">Ayudarme a concentrarme</option>
            </select>
        </div>

        <button class="btn btn-success" onclick="sendData()">Finalizar y Enviar</button>
    </div>

</div>

<script>
    // L√≥gica para el consentimiento
    function handleConsent() {
        const val = document.getElementById("consent").value;
        if (val === "No") {
            alert("Es necesario aceptar el consentimiento para continuar.");
            return;
        }
        nextSection(1);
    }

    function nextSection(current) {
        // Ocultar actual
        document.getElementById("section" + current).style.display = "none";
        document.getElementById("section" + current).classList.remove("active");
        
        // Mostrar siguiente
        const next = document.getElementById("section" + (current + 1));
        if(next) {
            next.style.display = "block";
            next.classList.add("active");
        }
    }

    function previousSection(current) {
        // Ocultar actual
        document.getElementById("section" + current).style.display = "none";
        document.getElementById("section" + current).classList.remove("active");

        // Mostrar anterior
        const prev = document.getElementById("section" + (current - 1));
        if(prev) {
            prev.style.display = "block";
            prev.classList.add("active");
        }
    }

    function sendData() {
        // 1. Recopilar G√©neros
        const genres = Array.from(
            document.querySelectorAll('.genreCheck:checked')
        ).map(x => x.value);

        // 2. Construir el objeto JSON con la NUEVA estructura
        const body = {
            consent: document.getElementById("consent").value === "Si",
            emotionalState: {
                emotion: document.getElementById("currentEmotion").value,
                intensity: Number(document.getElementById("emotionIntensity").value)
            },
            toneTest: {
                preferred: document.getElementById("likedTone").value,
                disliked: document.getElementById("dislikedTone").value
            },
            musicPreferences: {
                genres: genres,
                currentArtist: document.getElementById("currentArtist").value,
                tempoPreference: document.getElementById("tempoPref").value
            },
            intention: document.getElementById("emotionalGoal").value
        };

        console.log("üì§ Enviando JSON:", body);

        // 3. Enviar al servidor (Aseg√∫rate de que el servidor acepte esta estructura)
        fetch("http://10.40.46.10:5000/api/jilmar/recommend", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body)
        })
        .then(res => res.json())
        .then(data => {
            console.log("üì• Respuesta del servidor:", data);
            alert("Datos enviados correctamente. Revisa la consola.");
        })
        .catch(err => {
            console.error("‚ùå Error:", err);
            alert("Error al conectar con el servidor.");
        });
    }
</script>

</body>
</html>