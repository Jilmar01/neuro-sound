<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario Musical Personalizado</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="Styles/form.css">
    <style>
        /* Estilos adicionales para los reproductores de audio */
        audio {
            width: 100%;
            margin-bottom: 10px;
        }
        .genre-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
        }
    </style>
</head>

<body>

<div class="container mt-5">

    <div id="section1" class="section active">
        <h2>1. Consentimiento</h2>
        <div class="question">
            <label>¬øAcepta que sus respuestas se utilicen para personalizar su experiencia musical?</label>
            <select id="consent" class="form-select">
                <option value="Si">S√≠</option>
                <option value="No">No</option>
            </select>
        </div>
        <button class="btn btn-primary mt-3" onclick="handleConsent()">Siguiente</button>
    </div>

    <div id="section2" class="section" style="display:none;">
        <button class="btn btn-outline-secondary mb-3" onclick="previousSection(2)"><i class="bi bi-arrow-left"></i> Atr√°s</button>
        <h2>2. Estado Emocional</h2>

        <div class="question mb-3">
            <label>2.1 ¬øCu√°l de estas emociones describe mejor c√≥mo se siente ahora?</label>
            <select id="currentEmotion" class="form-select">
                <option value="T">Tristeza</option>
                <option value="C">Calma</option>
                <option value="F">Felicidad</option>
                <option value="I">Ira</option>
            </select>
        </div>

        <div class="question mb-3">
            <label>2.2 ¬øQu√© tan intensa es esta emoci√≥n? (1 = muy leve, 5 = muy fuerte)</label>
            <input id="emotionIntensity" type="range" class="form-range" min="1" max="5" step="1" value="1" oninput="document.getElementById('intensityVal').innerText = this.value">
            <div class="text-center fw-bold" id="intensityVal">3</div>
        </div>

        <button class="btn btn-primary" onclick="nextSection(2)">Siguiente</button>
    </div>

    <div id="section3" class="section" style="display:none;">
        <button class="btn btn-outline-secondary mb-3" onclick="previousSection(3)"><i class="bi bi-arrow-left"></i> Atr√°s</button>
        <h2>3. Test de Tonos Puros</h2>

        <div class="question mb-4">
            <label>3.1 Escuche los siguientes tonos:</label>
            <div class="mb-2">
                <strong>Tono 1:</strong>
                <audio controls>
                    
                </audio>
            </div>
            <div class="mb-2">
                <strong>Tono 2:</strong>
                <audio controls>
                    
                </audio>
            </div>
            <div class="mb-2">
                <strong>Tono 3:</strong>
                <audio controls>
                    
                </audio>
            </div>
        </div>

        <div class="question mb-3">
            <label>3.2 ¬øQu√© tono le agrad√≥ m√°s?</label>
            <select id="likedTone" class="form-select">
                <option value="Tono 1">Tono 1</option>
                <option value="Tono 2">Tono 2</option>
                <option value="Tono 3">Tono 3</option>
            </select>
        </div>

        <div class="question mb-3">
            <label>3.3 ¬øQu√© tono le desagrad√≥ m√°s?</label>
            <select id="dislikedTone" class="form-select">
                <option value="Tono 1">Tono 1</option>
                <option value="Tono 2">Tono 2</option>
                <option value="Tono 3">Tono 3</option>
            </select>
        </div>

        <button class="btn btn-primary" onclick="nextSection(3)">Siguiente</button>
    </div>

    <div id="section4" class="section" style="display:none;">
        <button class="btn btn-outline-secondary mb-3" onclick="previousSection(4)"><i class="bi bi-arrow-left"></i> Atr√°s</button>
        <h2>4. G√©neros Musicales Preferidos</h2>

        <div class="question mb-3">
            <label>Marque todos los que disfrute:</label>
            <div class="genre-grid mt-2">
                <div class="form-check"><input class="form-check-input genreCheck" type="checkbox" value="Blues"> <label>Blues</label></div>
                <div class="form-check"><input class="form-check-input genreCheck" type="checkbox" value="Indie"> <label>Indie</label></div>
                <div class="form-check"><input class="form-check-input genreCheck" type="checkbox" value="Reggae"> <label>Reggae</label></div>
                <div class="form-check"><input class="form-check-input genreCheck" type="checkbox" value="Soul"> <label>Soul</label></div>
                <div class="form-check"><input class="form-check-input genreCheck" type="checkbox" value="Ambient"> <label>Ambient</label></div>
                <div class="form-check"><input class="form-check-input genreCheck" type="checkbox" value="House"> <label>House</label></div>
                <div class="form-check"><input class="form-check-input genreCheck" type="checkbox" value="Reggaeton"> <label>Reggaeton</label></div>
                <div class="form-check"><input class="form-check-input genreCheck" type="checkbox" value="Rock"> <label>Rock</label></div>
                <div class="form-check"><input class="form-check-input genreCheck" type="checkbox" value="Classical"> <label>Classical</label></div>
                <div class="form-check"><input class="form-check-input genreCheck" type="checkbox" value="Pop"> <label>Pop</label></div>
                <div class="form-check"><input class="form-check-input genreCheck" type="checkbox" value="Folk"> <label>Folk</label></div>
                <div class="form-check"><input class="form-check-input genreCheck" type="checkbox" value="Metal"> <label>Metal</label></div>
                <div class="form-check"><input class="form-check-input genreCheck" type="checkbox" value="EDM"> <label>EDM</label></div>
                <div class="form-check"><input class="form-check-input genreCheck" type="checkbox" value="Hip-Hop"> <label>Hip-Hop</label></div>
                <div class="form-check"><input class="form-check-input genreCheck" type="checkbox" value="K-Pop"> <label>K-Pop</label></div>
                <div class="form-check"><input class="form-check-input genreCheck" type="checkbox" value="Country"> <label>Country</label></div>
                <div class="form-check"><input class="form-check-input genreCheck" type="checkbox" value="RnB"> <label>RnB</label></div>
                <div class="form-check"><input class="form-check-input genreCheck" type="checkbox" value="Jazz"> <label>Jazz</label></div>
                <div class="form-check"><input class="form-check-input genreCheck" type="checkbox" value="Lofi"> <label>Lofi</label></div>
                <div class="form-check"><input class="form-check-input genreCheck" type="checkbox" value="Gospel"> <label>Gospel</label></div>
            </div>
        </div>

        <div class="question mb-3">
            <label>4.1 Artista actual de inter√©s:</label>
            <input type="text" id="currentArtist" class="form-control" placeholder="Dua Lipa, The Weeknd, etc.">
        </div>

        <div class="question mb-3">
            <label>4.2 Preferencia de tipo de canci√≥n:</label>
            <select id="tempoPref" class="form-select">
                <option value="Muy lentas y solemnes">Muy lentas y solemnes</option>
                <option value="Lentas y tranquilas">Lentas y tranquilas</option>
                <option value="Ritmo moderado">Ritmo moderado</option>
                <option value="R√°pidas y animadas">R√°pidas y animadas</option>
                <option value="Muy r√°pidas e intensas">Muy r√°pidas e intensas</option>
            </select>
        </div>

        <button class="btn btn-primary" onclick="nextSection(4)">Siguiente</button>
    </div>

    <div id="section5" class="section" style="display:none;">
        <button class="btn btn-outline-secondary mb-3" onclick="previousSection(5)"><i class="bi bi-arrow-left"></i> Atr√°s</button>
        <h2>5. Intenci√≥n Emocional</h2>

        <div class="question mb-3">
            <label>Seleccione lo que desea que la m√∫sica haga por usted:</label>
            <select id="emotionalGoal" class="form-select">
                <option value="Mantener c√≥mo me siento">Mantener c√≥mo me siento</option>
                <option value="Sentirme m√°s feliz">Sentirme m√°s feliz</option>
                <option value="Relajarme">Relajarme</option>
                <option value="Aumentar mi energ√≠a">Aumentar mi energ√≠a</option>
                <option value="Ayudarme a concentrarme">Ayudarme a concentrarme</option>
            </select>
        </div>

        <button class="btn btn-success" onclick="sendData()">Finalizar y Enviar</button>
    </div>

</div>

<script>
        // Variable global o local para almacenar la emoci√≥n seleccionada actualmente
    let currentEmotion = "T"; // Valor predeterminado (Tristeza)

    /**
     * Funci√≥n auxiliar para extraer la letra de la emoci√≥n del nombre de archivo.
     * @param {string} fileName - El nombre del archivo de audio (ej: 'tone_110hz_20s T.wav').
     * @returns {string | null} - La letra de la emoci√≥n (T, C, F, I) o null si no se encuentra.
     */
    function getEmotionCodeFromFileName(fileName) {
        // Definimos un patr√≥n de expresi√≥n regular:
        // \s: busca un espacio en blanco
        // ([TCFI]): captura la letra de la emoci√≥n (T, C, F, I)
        // \.: busca un punto (antes de la extensi√≥n .wav)
        const regex = /\s([TCFI])\./;
        const match = fileName.match(regex);

        // Si se encuentra una coincidencia, devuelve el primer grupo capturado (la letra)
        if (match && match.length > 1) {
            return match[1];
        }
        return null;
    }

    /**
     * Funci√≥n principal que cambia la fuente (src) de los reproductores de audio
     * bas√°ndose en la emoci√≥n seleccionada.
     */
    function putSoundEmotion() {
        // 1. Obtener la emoci√≥n seleccionada del selector (ej: "T", "C", "F", "I")
        const selector = document.getElementById("currentEmotion");
        if (!selector) {
            console.error("El selector de emoci√≥n (ID: currentEmotion) no se encontr√≥.");
            return;
        }
        // Asume que el valor de la opci√≥n es la letra de la emoci√≥n (T, C, F, I)
        currentEmotion = selector.value; 

        // 2. Obtener todos los elementos de audio
        const audioPlayers = document.querySelectorAll("audio");
        if (audioPlayers.length === 0) {
            console.warn("No se encontraron elementos <audio> en la p√°gina.");
            return;
        }

        // 3. Obtener la lista de todos los archivos de audio disponibles
        // **Nota importante:** En un entorno real, no puedes leer el sistema de archivos del servidor
        // o el cliente directamente con JavaScript. Debes tener una lista predefinida o
        // cargarla a trav√©s de una API.
        // Para el ejemplo, usaremos una lista simulada de archivos disponibles en la carpeta "frecuences":
        const availableAudios = [
            "frecuences/tone_110hz_20s T.wav", // Tristeza
            "frecuences/tone_174hz_20s T.wav", // Tristeza
            "frecuences/tone_210hz_20s T.wav", // Calma
            "frecuences/tone_285hz_20s C.wav", // Calma
            "frecuences/tone_396hz_20s C.wav", // Felicidad
            "frecuences/tone_417hz_20s C.wav", // Ira
            "frecuences/tone_440hz_20s F.wav", // Felicidad
            "frecuences/tone_528hz_20s F.wav", // Ira
            "frecuences/tone_639hz_20s F.wav", // Tristeza
            "frecuences/tone_741hz_20s I.wav", // Calma
            "frecuences/tone_852hz_20s I.wav", // Felicidad
            "frecuences/tone_963hz_20s I.wav", // Ira
        ];
        
        // 4. Filtrar los audios que coinciden con la emoci√≥n seleccionada
        const matchingAudios = availableAudios.filter(audioPath => {
            const emotionCode = getEmotionCodeFromFileName(audioPath);
            return emotionCode === currentEmotion;
        });

        if (matchingAudios.length === 0) {
            console.warn(`No se encontraron audios para la emoci√≥n: ${currentEmotion}`);
            return;
        }
        
        // 5. Asignar los archivos a los reproductores de audio
        audioPlayers.forEach((audioElement, index) => {
            // Usa el operador m√≥dulo (%) para repetir los archivos si hay m√°s reproductores que archivos
            const audioPath = matchingAudios[index % matchingAudios.length];
            
            // Asignar el nuevo src y recargar el audio
            audioElement.src = audioPath;
            audioElement.load(); // Es importante llamar a .load() para que el navegador cargue la nueva fuente
            
            console.log(`Reproductor ${index + 1} actualizado con: ${audioPath}`);
        });
        document.addEventListener("DOMContentLoaded", () => {
        const selector = document.getElementById("emotionSelector");
        if (selector) {
            selector.addEventListener("change", putSoundEmotion);
            // Establecer los audios iniciales
            putSoundEmotion();
        }
        
        // A√ëADIR ESTA L√çNEA para habilitar el control de reproducci√≥n √∫nica
        handleSingleAudioPlay();
    });
    }

    // 6. Configurar el Event Listener
    // Escucha el evento 'change' en el selector para ejecutar la funci√≥n autom√°ticamente.
    document.addEventListener("DOMContentLoaded", () => {
        const selector = document.getElementById("currentEmotion");
        if (selector) {
            selector.addEventListener("change", putSoundEmotion);
            // Opcional: Ejecutar una vez al cargar para establecer los audios por defecto
            putSoundEmotion();
        }
    });

        /**
     * Configura todos los elementos <audio> para que solo uno pueda reproducirse a la vez.
     * Cuando un audio comienza a sonar, pausa todos los dem√°s.
     */
    function handleSingleAudioPlay() {
        // 1. Obtener todos los elementos de audio en la p√°gina
        const audioPlayers = document.querySelectorAll("audio");

        // 2. Iterar sobre cada reproductor para asignarle un 'event listener'
        audioPlayers.forEach(player => {
            // A√±adir el listener si no tiene uno para evitar duplicados
            player.removeEventListener('play', pauseOtherAudios);
            player.addEventListener('play', pauseOtherAudios);
        });
    }

    /**
     * Funci√≥n que se ejecuta cuando un audio comienza a reproducirse.
     * Pausa todos los dem√°s elementos de audio.
     * @param {Event} event - El evento 'play' que se dispar√≥.
     */
    function pauseOtherAudios(event) {
        // 1. Obtener el elemento que dispar√≥ el evento (el audio que acaba de empezar a sonar)
        const currentPlayingAudio = event.target;
        
        // 2. Obtener todos los reproductores de audio
        const allAudios = document.querySelectorAll("audio");

        // 3. Iterar y pausar cualquier reproductor que NO sea el actual
        allAudios.forEach(audio => {
            // Comprobar si el audio actual en el loop NO es el que se est√° reproduciendo ahora
            if (audio !== currentPlayingAudio) {
                // Pausar si no es el reproductor actual
                audio.pause();
                // Opcional: Reiniciar la posici√≥n de reproducci√≥n al inicio
                // audio.currentTime = 0; 
            }
        });
    }


    // --- Llama a esta funci√≥n para aplicar la restricci√≥n ---
    // Aseg√∫rate de que esta funci√≥n se ejecute despu√©s de que los elementos <audio>
    // hayan sido cargados en el DOM, por ejemplo, dentro de 'DOMContentLoaded'.
    document.addEventListener("DOMContentLoaded", () => {
        // ... (Tu c√≥digo existente, como putSoundEmotion, puede ir aqu√≠) ...
        
        // Llama a la nueva funci√≥n
        handleSingleAudioPlay();
    });
    
    // L√≥gica para el consentimiento
    function handleConsent() {
        const val = document.getElementById("consent").value;
        if (val === "No") {
            alert("Es necesario aceptar el consentimiento para continuar.");
            return;
        }
        nextSection(1);
    }

    function nextSection(current) {
        // Ocultar actual
        document.getElementById("section" + current).style.display = "none";
        document.getElementById("section" + current).classList.remove("active");
        
        // Mostrar siguiente
        const next = document.getElementById("section" + (current + 1));
        if(next) {
            next.style.display = "block";
            next.classList.add("active");
        }
    }

    function previousSection(current) {
        // Ocultar actual
        document.getElementById("section" + current).style.display = "none";
        document.getElementById("section" + current).classList.remove("active");

        // Mostrar anterior
        const prev = document.getElementById("section" + (current - 1));
        if(prev) {
            prev.style.display = "block";
            prev.classList.add("active");
        }
    }

    function sendData() {
        // 1. Recopilar G√©neros
        const genres = Array.from(
            document.querySelectorAll('.genreCheck:checked')
        ).map(x => x.value);

        // 2. Construir el objeto JSON con la NUEVA estructura
        const body = {
            consent: document.getElementById("consent").value === "Si",
            emotionalState: {
                emotion: document.getElementById("currentEmotion").value,
                intensity: Number(document.getElementById("emotionIntensity").value)
            },
            toneTest: {
                preferred: document.getElementById("likedTone").value,
                disliked: document.getElementById("dislikedTone").value
            },
            musicPreferences: {
                genres: genres,
                currentArtist: document.getElementById("currentArtist").value,
                tempoPreference: document.getElementById("tempoPref").value
            },
            intention: document.getElementById("emotionalGoal").value
        };

        console.log("üì§ Enviando JSON:", body);

        // 3. Enviar al servidor (Aseg√∫rate de que el servidor acepte esta estructura)
        fetch("http://127.0.0.1:5000/api/survey/register", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body)
        })
        .then(res => res.json())
        .then(data => {
            console.log("üì• Respuesta del servidor:", data);
            alert("Datos enviados correctamente. Revisa la consola.");
            window.locartion.href = "home.html";
        })
        .catch(err => {
            console.error("‚ùå Error:", err);
            alert("Error al conectar con el servidor.");
        });
    }
</script>

</body>
</html>